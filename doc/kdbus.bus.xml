<?xml version='1.0'?> <!--*-nxml-*-->
<!DOCTYPE refentry PUBLIC "-//OASIS//DTD DocBook XML V4.2//EN"
        "http://www.oasis-open.org/docbook/xml/4.2/docbookx.dtd">

<refentry id="kdbus.bus">

  <refentryinfo>
    <title>kdbus.bus</title>
    <productname>kdbus.bus</productname>
  </refentryinfo>

  <refmeta>
    <refentrytitle>kdbus.bus</refentrytitle>
    <manvolnum>7</manvolnum>
  </refmeta>

  <refnamediv>
    <refname>kdbus.bus</refname>
    <refpurpose>kdbus bus</refpurpose>
  </refnamediv>

  <refsect1>
    <title>Description</title>

    <para>
      A bus is a resource that is shared between connections in order to transmit
      messages (see <citerefentry><refentrytitle>kdbus.message</refentrytitle><manvolnum>7</manvolnum></citerefentry>).
      Each bus is independent and operations on the bus will not have any
      effect on other buses. A bus is a management entity, that controls the
      addresses of its connections, their policies and message transactions performed
      via this bus.
    </para>
    <para>
      Each bus is bound to the mount instance it was created on. It has a custom name that is
      unique across all buses of a domain. In
      <citerefentry><refentrytitle>kdbus.fs</refentrytitle><manvolnum>7</manvolnum></citerefentry>),
      a bus is presented as a directory. No operations can be performed on
      the bus itself; instead you need to perform the operations on an endpoint
      associated with the bus. Endpoints are accessible as files underneath the
      bus directory. A default endpoint called "bus" is provided on each bus.
    </para>
    <para>
      Bus names may be chosen freely except for one restriction: the name
      must be prefixed with the numeric effective UID of the creator and a dash. This
      is required to avoid namespace clashes between different users. When creating a
      bus, that name that is passed in must be properly formatted, or the kernel will
      refuse creation of the bus. Example: "1047-foobar" is an acceptable name for a
      bus registered by a user with UID 1047. However, "1024-foobar" is not, and
      neither is "foobar". The UID must be provided in the user-namespace of the
      parent domain.
    </para>
    <para>
      To create a new bus, you need to open the control file of a domain and employ
      the <varname>KDBUS_CMD_BUS_MAKE</varname> ioctl. The control file descriptor that was used to issue
      KDBUS_CMD_BUS_MAKE must not previously have been used for any other
      control-ioctl and must be kept open for the entire life-time of the created
      bus. Closing it will immediately cleanup the entire bus and all its associated
      resources and endpoints. Every control file descriptor can only be used to
      create a single new bus; from that point on, it is not used for any further
      communication until the final close().
    </para>
    <para>
      Each bus will generate a random, 128-bit UUID upon creation. This UUID will be
      returned to creators of connections through kdbus_cmd_hello.id128 and can
      be used by userspace to uniquely identify buses, even across different machines
      or containers. The UUID will have its variant bits set to 'DCE', and denote
      version 4 (random). For more details on UUIDs, see
      <ulink url="https://en.wikipedia.org/wiki/Universally_unique_identifier">
      the Wikipedia entry on UUIDs</ulink>.
    </para>

  </refsect1>

  <refsect1>
    <title>Creating buses and endpoints</title>
    <para>
      To create a new bus, the <varname>KDBUS_CMD_BUS_MAKE</varname>
      command is used. It takes a <varname>struct kdbus_cmd_make</varname> argument.
    </para>
    <programlisting>
struct kdbus_cmd_make {
  __u64 size;
  __u64 flags;
  __u64 kernel_flags;
  __u64 return_flags;
  struct kdbus_item items[0];
};
    </programlisting>

    <para>The fields in this struct are described below.</para>

    <variablelist>
      <varlistentry>
        <term><varname>size</varname></term>
        <listitem><para>
          The overall size of the struct, including its items.
        </para></listitem>
      </varlistentry>

      <varlistentry>
        <term><varname>flags</varname></term>
        <listitem><para>The flags for creation.</para>
          <variablelist>
            <varlistentry>
              <term><varname>KDBUS_MAKE_ACCESS_GROUP</varname></term>
              <listitem>
                <para>Make the bus or endpoint file group-accessible</para>
              </listitem>
            </varlistentry>

            <varlistentry>
              <term><varname>KDBUS_MAKE_ACCESS_WORLD</varname></term>
              <listitem>
                <para>Make the bus or endpoint file world-accessible</para>
              </listitem>
            </varlistentry>
          </variablelist>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><varname>kernel_flags</varname></term>
        <listitem><para>
          Valid flags for this command, returned by the kernel upon each call.
        </para></listitem>
      </varlistentry>

      <varlistentry>
        <term><varname>return_flags</varname></term>
        <listitem><para>
          Flags returned by the kernel. Currently unused and always set to
          zero by the kernel.
        </para></listitem>
      </varlistentry>

      <varlistentry>
        <term><varname>items</varname></term>
        <listitem>
          <para>
            The following items (see
            <citerefentry><refentrytitle>kdbus.item</refentrytitle><manvolnum>7</manvolnum></citerefentry>)
            are expected for <varname>KDBUS_CMD_BUS_MAKE</varname>.
          </para>
          <variablelist>
            <varlistentry>
              <term><varname>KDBUS_ITEM_MAKE_NAME</varname></term>
              <listitem>
                <para>
                  Contains a null-terminated string that identifies the
                  bus. The name must be unique across the kdbus domain and
                  must start with the effective UID of the caller, followed by
                  a '-'. This item is mandatory.
                </para>
              </listitem>
            </varlistentry>

            <varlistentry>
              <term><varname>KDBUS_ITEM_BLOOM_PARAMETER</varname></term>
              <listitem>
                <para>
                  Bus-wide bloom parameters passed in a
                  <varname>struct kdbus_bloom_parameter</varname>. These
                  settings are copied back to new connections verbatim.
                  This item is mandatory.
                  See
                  <citerefentry><refentrytitle>kdbus.item</refentrytitle><manvolnum>7</manvolnum></citerefentry>
                  for a detailed description of this item.
                </para>
              </listitem>
            </varlistentry>

            <varlistentry>
              <term><varname>KDBUS_ITEM_ATTACH_FLAGS_RECV</varname></term>
              <listitem>
                <para>An optional item that contains a set of required attach
                  flags that connections must allow. This item is used as a negotiation
                  measure during connection creation. If connections do not satisfy
                  the bus requirements, they are not allowed on the bus.
                  If not set, the bus does not require any metadata to be attached;
                  in this case connections are free to set their own attach flags.
                </para>
              </listitem>
            </varlistentry>

            <varlistentry>
              <term><varname>KDBUS_ITEM_ATTACH_FLAGS_SEND</varname></term>
              <listitem>
                <para>
                  An optional item that contains a set of attach flags that are
                  returned to connections when they query the bus creator
                  metadata. If not set, no metadata is returned.
                </para>
              </listitem>
            </varlistentry>
          </variablelist>
        </listitem>
      </varlistentry>
    </variablelist>

    <para>
      Unrecognized items are rejected, and the ioctl will fail with
      <varname>-EINVAL</varname>.
    </para>
  </refsect1>

  <refsect1>
    <title>Return value</title>
    <para>
      On success, all mentioned ioctl commands return 0.
    </para>

    <refsect2>
      <title><varname>KDBUS_CMD_BUS_MAKE</varname> may return the following errors</title>

      <variablelist>
        <varlistentry>
          <term><varname>-EBADMSG</varname></term>
          <listitem><para>
            A mandatory item is missing.
          </para></listitem>
        </varlistentry>

        <varlistentry>
          <term><varname>-EINVAL</varname></term>
          <listitem><para>
            The flags supplied in the <varname>struct kdbus_cmd_make</varname>
            are invalid or the supplied name does not start with the current
            UID and a '-'.
          </para></listitem>
        </varlistentry>

        <varlistentry>
          <term><varname>-EEXIST</varname></term>
          <listitem><para>
            A bus of that name already exists.
          </para></listitem>
        </varlistentry>

        <varlistentry>
          <term><varname>-ESHUTDOWN</varname></term>
          <listitem><para>
            The kdbus mount instance for the bus was already shut down.
          </para></listitem>
        </varlistentry>

        <varlistentry>
          <term><varname>-EMFILE</varname></term>
          <listitem><para>
            The maximum number of buses for the current user is exhausted.
          </para></listitem>
        </varlistentry>
      </variablelist>
    </refsect2>
  </refsect1>

  <refsect1>
    <title>See Also</title>
    <simplelist type="inline">
      <member><citerefentry><refentrytitle>kdbus</refentrytitle><manvolnum>7</manvolnum></citerefentry></member>
      <member><citerefentry><refentrytitle>kdbus.connection</refentrytitle><manvolnum>7</manvolnum></citerefentry></member>
      <member><citerefentry><refentrytitle>kdbus.endpoint</refentrytitle><manvolnum>7</manvolnum></citerefentry></member>
      <member><citerefentry><refentrytitle>kdbus.fs</refentrytitle><manvolnum>7</manvolnum></citerefentry></member>
      <member><citerefentry><refentrytitle>kdbus.item</refentrytitle><manvolnum>7</manvolnum></citerefentry></member>
      <member><citerefentry><refentrytitle>kdbus.message</refentrytitle><manvolnum>7</manvolnum></citerefentry></member>
      <member><citerefentry><refentrytitle>kdbus.names</refentrytitle><manvolnum>7</manvolnum></citerefentry></member>
      <member><citerefentry><refentrytitle>kdbus.pool</refentrytitle><manvolnum>7</manvolnum></citerefentry></member>
    </simplelist>
  </refsect1>
</refentry>
